## Maya for DevOps

authors - @amitd
version - 0.6.0
last updated - 20 Dec 2017
description - DevOps gets a storage controller than a storage volume

NOTE: This should be a living document that should be updated as & when facts change.

### Introduction -- Maya enables OpenEBS
OpenEBS storage can be thought of as a logical concept over persistent storage. OpenEBS is an abstraction over various filesystems. OpenEBS currently supports jiva & cstor as two different filesystems. These filesystems are openly developed and represent themselves as storage controllers that operate from within a container. It can be further assumed that operators might like to use Maya to provide management over various filesystems apart from jiva & cstor. This fuels the need for maya to be a transparent control plane for openebs storage.

In addition, our users have talked about the scenarios, if maya can be the tool to compose layers of filesystems (as it has always been the case with storage e.g. jiva on freenas, cstor on Amazon EBS, etc.).

### Some Facts -- Volume Provisioning in Kubernetes
This will detail the workflow implemented by Kubernetes to provision persistent storage. While most of this is documented in Kubernetes, we shall quote them here as well to provide continuity to the reader.

Kubernetes clusters have a variety of volumes which differ widely in size, iops performance, retention policy, and other characteristics. Administrators need a way to dynamically provision volumes of these different types to automatically meet user demand.

This mechanism to provision volumes dynamically is done via 'storage class'. It is technically referred as `Kind: StorageClass`. A StorageClass works with other Kubernetes Kinds known as PersisentVolumeClaim & PersistentVolume to provision volumes.

The logic that ties all of the above specifications is the provisioner. In case of openebs, it is an external provisioner i.e. out-of-tree provisioner. This provisioner is known as openebs-provisioner.

### Provisioning OpenEBS volumes in Kubernetes
Maya's main goal is to provision openebs volumes in Kubernetes. These provisioned storages are in turn used as volumes in Kubernetes applications. 

#### Provisioning in OpenEBS 0.5.0
As of openebs 0.5.0 release, maya provisions jiva based volumes only. Maya here refers to openebs-provisioner & maya-apiserver components. Maya exposes a jiva volume as a set of Kubernetes objects. They are `Kind: Service` and couple of `Kind: Deployment` objects. These specifications are generated by maya & installed on K8s cluster using K8s exposed APIs. Maya also makes use of StorageClass to provide various storage specific options commonly referred to as StoragePolicy options.

- More on OpenEBS 0.5.0 policies can be found [here](http://openebs.readthedocs.io/en/latest/Policies/storage_policy.html#storage-pool-policy)

- A sample StorageClass that registers openebs-provisioner & couple of openebs specific policies
```yaml
# A storage class supported by OpenEBS 0.5.0
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
   name: openebs-standalone
provisioner: openebs.io/provisioner-iscsi
parameters:
  openebs.io/storage-pool: "default"
  openebs.io/jiva-replica-count: "2"
  openebs.io/volume-monitor: "true"
```

- kubectl output after a persistent volume named `myvol` is created using maya
```yaml
ubuntu@kubemaster-01:/vagrant$ kubectl get service
NAME                     CLUSTER-IP      EXTERNAL-IP   PORT(S)             AGE
myvol-ctrl-svc           10.111.100.12   <none>        3260/TCP,9501/TCP   9m

ubuntu@kubemaster-01:/vagrant$ kubectl get deploy
NAME                  DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
myvol-ctrl    1         1         1            1           5m
myvol-rep     2         2         2            2           5m

$ kubectl get pvc
NAME          STATUS    VOLUME  CAPACITY   ACCESS MODES   STORAGECLASS         AGE
myvol-claim   Bound     myvol   4G         RWO            openebs-standalone   1d

$ kubectl get pv
NAME    CAPACITY ACCESS MODES  RECLAIM POLICY STATUS   CLAIM                STORAGECLASS         REASON    AGE
myvol   4G       RWO           Delete         Bound    default/myvol-claim   openebs-standalone             1d
```

#### Provisioning in OpenEBS 0.6.0 [WIP]
It is currently difficult for a Kubernetes (K8s) application to know how to set up and run a openebs persistent volume that meets the application's workload characteristics. Though there are a lot of options available via maya which is the control plane of openebs storage, these are all programmed code and few of these are exposed declaratively. This in turn becomes a sort of black box to consumers of openebs. To help reduce the mystery, this document provides opinions on how to design maya for DevOps. The end goal of this document will be to design maya that does not come in between the users and their favorite tools including K8s & yet is able to provide openebs storage.


### Others

#### Maya enabling multi-tenancy [WIP]
The main objective of maya is enabling openebs. However, there will be multiple orthogonal requirements which maya should not obstruct. Multi-tenancy is one such orthogonal requirement.

Let us start with by quoting some use-cases that we have lifted from various communication channels.

>Exactly what it means for a cluster to be “configured for multitenancy” is not well-defined. Some cluster admins may want strong “control plane multitenancy” so as to support many users, but not care about strong “node multitenancy” because they only run trusted workloads or are willing to isolate workloads onto dedicated nodes. Others may want strong “node multitenancy” because they run untrusted workloads, but not care about “control plane multitenancy” because there is effectively only one user (e.g. end-users interact with a SaaS control plane that is the only direct user of the Kubernetes control plane). Others will want both. ... we assume both are desired; it is easy enough to figure out which options you can ignore if you don’t need one or the other... describes a more comprehensive taxonomy of multitenancy models.

#### Maya enabling security [WIP]
The main objective of maya is enabling openebs. However, there will be multiple orthogonal requirements which maya should not obstruct. Security is one such orthogonal requirement.

Let us start with by quoting some characteristics that we have lifted from various communication channels.

>Earlier versions of Kubernetes introduced role-based access control (RBAC) as a beta feature. RBAC lets an admin define access permissions to Kubernetes resources, such as pods or secrets, and then grant (“bind”) them to one or more users. Permissions can be for changing things (“create,” “update,” “patch”) or just obtaining information about them (“get,” “list,” “watch”). Roles can be applied on a single namespace or across an entire cluster, via two distinct APIs.

>Cloud native storage should provide a `natively secure` philosophy.

### Design Tips from Kubernetes
We shall list down some of the design & coding tips for maya to behave nicely with Kubernetes. These are various suggestions, tips, best practices, etc from various Kubernetes channels. These should not be used as a hard rule but as a guiding factor. Maya being an open source software lets its' contributors to have the final say.

- This is w.r.t deleting a PersistentVolume
> Note that watching pv.Status has been frowned upon in the past, however in this particular case we could use it quite reliably to trigger deletion. It's not trivial to find out if a PV is not needed and should be deleted. Alternatively, an annotation could be used.

> Controller should only be concerned with its own Object(s). It should not mutate objects that are controlled by other controllers.

> Controller can make use of Annotations to specify if a particular object belongs to it or not.

> Controller can update the status of its own object.

> Kubernetes objects including its extensions should be agile.

### References
- [Multitenancy Model for Kubernetes](https://docs.google.com/document/d/15w1_fesSUZHv-vwjiYa9vN_uyc--PySRoLKTuDhimjc/)
- [Multi-tenant security/isolation configuration](https://docs.google.com/document/d/1jAcsC4sLgEV9__TdgJrMvPa3G73G62tFtMcKQgeIlHM/)
- [whats-new-in-kubernetes-containers](https://www.infoworld.com/article/3229359/containers/whats-new-in-kubernetes-containers.html)
