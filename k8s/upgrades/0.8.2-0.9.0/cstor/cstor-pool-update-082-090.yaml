# CASTemplate cstor-pool-update-082-090 is
# used to upgrade single cstor pool 
apiVersion: openebs.io/v1alpha1
kind: CASTemplate
metadata:
  name: cstor-pool-update-082-090
spec:
  defaultConfig:
  - name: baseversion
    value: "0.8.2"
  - name: targetversion
    value: "v0.9.0-RC1"
  - name: successStatus
    value: "Success"
  - name: failStatus
    value: "Fail"
  run:
    tasks:
    - upgrade-cstor-pool-082-090-get-cstorpool
    - upgrade-cstor-pool-082-090-get-deployment
    - upgrade-cstor-pool-082-090-get-storagepool
    - upgrade-cstor-pool-082-090-patch-upgrade-result
    - upgrade-cstor-pool-082-090-patch-deployment-image
    - upgrade-cstor-pool-082-090-patch-deployment-image-status
    - upgrade-cstor-pool-082-090-post-check-patch-deployment-image
    - upgrade-cstor-pool-082-090-list-replicaset
    - upgrade-cstor-pool-082-090-list-pod
    - upgrade-cstor-pool-082-090-get-pool-pod
    - upgrade-cstor-pool-082-090-pre-check-quorum
    - upgrade-cstor-pool-082-090-set-quorum
    - upgrade-cstor-pool-082-090-post-check-quorum
    - upgrade-cstor-pool-082-090-pool-deployment-status
    - upgrade-cstor-pool-082-090-patch-sp-version
    - upgrade-cstor-pool-082-090-patch-sp-version-post-check
    - upgrade-cstor-pool-082-090-patch-csp-version
    - upgrade-cstor-pool-082-090-patch-csp-version-post-check
    - upgrade-cstor-pool-082-090-patch-deployment-version
    - upgrade-cstor-pool-082-090-patch-deployment-version-post-check
    - upgrade-cstor-pool-082-090-delete-replicaset
  taskNamespace: default
---
# upgrade-cstor-pool-082-090-get-cstorpool gets details of CStorPool CR.
# This runtask is for get object info which will use in some runtask.
# This should always run.
apiVersion: openebs.io/v1alpha1
kind: RunTask
metadata:
  name: upgrade-cstor-pool-082-090-get-cstorpool
  namespace: default
spec:
  meta: |
    id: CStorPool
    apiVersion: openebs.io/v1alpha1
    kind: CStorPool
    action: get
    objectName: {{ .UpgradeItem.name }}
    disable: false
  post: |
    {{- jsonpath .JsonResult "{.metadata.uid}" | trim | saveAs "CStorPool.uid" .TaskResult | noop -}}

    {{- $taskName := "upgrade-cstor-pool-082-090-get-cstorpool" -}}
    {{- $message := printf "Successfully get details of CStorPool {%s}." .UpgradeItem.name -}}
    {{- updateUpgradeResult .UpgradeItem.upgradeResultName .UpgradeItem.upgradeResultNamespace $taskName .Config.successStatus.value $message 0 now -}}
---
# upgrade-cstor-pool-082-090-get-cstorpool gets details of Pool Deployment.
# This runtask is for get object info which will use in some runtask.
# This should always run.
apiVersion: openebs.io/v1alpha1
kind: RunTask
metadata:
  name: upgrade-cstor-pool-082-090-get-deployment
  namespace: default
spec:
  meta: |
    id: poolDeployment
    apiVersion: extensions/v1beta1
    kind: Deployment
    action: get
    objectName: {{ .UpgradeItem.name }}
    runNamespace: {{ .UpgradeItem.namespace }}
    disable: false
  post: |
    {{- jsonpath .JsonResult "{.spec.template.spec.containers[?(@.name=='cstor-pool')].image}" | trim | saveAs "poolDeployment.cstorpoolimage" .TaskResult | noop -}}
    {{- jsonpath .JsonResult "{.spec.template.spec.containers[?(@.name=='cstor-pool-mgmt')].image}" | trim | saveAs "poolDeployment.cstorpoolmgmtimage" .TaskResult | noop -}}

    {{- $taskName := "upgrade-cstor-pool-082-090-get-deployment" -}}
    {{- $message := printf "Successfully get details of pool deployment {%s} in {%s} namespace." .UpgradeItem.name .UpgradeItem.namespace -}}
    {{- updateUpgradeResult .UpgradeItem.upgradeResultName .UpgradeItem.upgradeResultNamespace $taskName .Config.successStatus.value $message 0 now -}}
---
# upgrade-cstor-pool-082-090-get-cstorpool gets details of StoragePool CR.
# This runtask is for get object info which will use in some runtask.
# This should always run.
apiVersion: openebs.io/v1alpha1
kind: RunTask
metadata:
  name: upgrade-cstor-pool-082-090-get-storagepool
  namespace: default
spec:
  meta: |
    id: StoragePool
    apiVersion: openebs.io/v1alpha1
    kind: StoragePool
    action: get
    objectName: {{ .UpgradeItem.name }}
    disable: false
  post: |

    {{- $taskName := "upgrade-cstor-pool-082-090-get-storagepool" -}}
    {{- $message := printf "Successfully get details of StoragePool {%s}." .UpgradeItem.name -}}
    {{- updateUpgradeResult .UpgradeItem.upgradeResultName .UpgradeItem.upgradeResultNamespace $taskName .Config.successStatus.value $message 0 now -}}
---
apiVersion: openebs.io/v1alpha1
kind: RunTask
metadata:
  name: upgrade-cstor-pool-082-090-patch-upgrade-result
  namespace: default
spec:
  meta: |
    id: patchResult
    apiVersion: openebs.io/v1alpha1
    kind: UpgradeResult
    action: patch
    objectName: {{ .UpgradeItem.upgradeResultName }}
    runNamespace: {{ .UpgradeItem.upgradeResultNamespace }}
  task: |-
    type: merge
    pspec: |-
      status:
        resource:
          name: {{ .UpgradeItem.name }}
          namespace: {{ .UpgradeItem.namespace }}
          kind: {{ .UpgradeItem.kind }} 
---
apiVersion: openebs.io/v1alpha1
kind: RunTask
metadata:
  name: upgrade-cstor-pool-082-090-patch-deployment-image
  namespace: default
spec:
  meta: |
    {{ $isOldCStorPool := contains .TaskResult.poolDeployment.cstorpoolimage .Config.baseversion.value }}
    {{ $isOldCStorPoolMGMT := eq .TaskResult.poolDeployment.cstorpoolmgmtimage "" }}
    {{ $shouldpatch := or $isOldCStorPool $isOldCStorPoolMGMT | toString }}
    id: patchDeploymentImage
    apiVersion: extensions/v1beta1
    kind: Deployment
    action: patch
    objectName: {{ .UpgradeItem.name }}
    runNamespace: {{ .UpgradeItem.namespace }}
  task: |-
    type: strategic
    pspec: |-
      spec:
        template:
          spec:
            containers:
            - name: cstor-pool
              image: quay.io/openebs/cstor-pool:v0.9.x-ci
              env:
              - name: OPENEBS_IO_CSTOR_ID
                value: {{ .TaskResult.CStorPool.uid }}
              livenessProbe:
                exec:
                  command:
                  - "/bin/sh"
                  - "-c"
                  - zfs set io.openebs:livenesstimestap='$(date)' cstor-$OPENEBS_IO_CSTOR_ID
                failureThreshold: 3
                initialDelaySeconds: 300
                periodSeconds: 10
                successThreshold: 1
                timeoutSeconds: 30
            - name: cstor-pool-mgmt
              image: quay.io/openebs/cstor-pool-mgmt:v0.9.x-ci
              # Setting ports to nil, since it is not required and 
              # 9500 port is used by m-exporter
              ports:
            - name: maya-exporter
              image: quay.io/openebs/m-exporter:v0.9.x-ci
              command:
              - maya-exporter
              args:
              - "-e=pool"
              ports:
              - containerPort: 9500
                protocol: TCP
              securityContext:
                privileged: true
              volumeMounts:
              - mountPath: /dev
                name: device
              - mountPath: /tmp
                name: tmp
              - mountPath: /var/openebs/sparse
                name: sparse
              - mountPath: /run/udev
                name: udev
  post: |-

    {{- $taskName := "upgrade-cstor-pool-082-090-patch-deployment-image" -}}
    {{- $message := "Successfully patched deployment image." -}}
    {{- updateUpgradeResult .UpgradeItem.upgradeResultName .UpgradeItem.upgradeResultNamespace $taskName .Config.successStatus.value $message 0 now -}}
    
---
apiVersion: openebs.io/v1alpha1
kind: RunTask
metadata:
  name: upgrade-cstor-pool-082-090-patch-deployment-image-status
  namespace: default
spec:
  meta: |
    {{ $isOldCStorPool := contains .TaskResult.poolDeployment.cstorpoolimage .Config.baseversion.value }}
    {{ $isOldCStorPoolMGMT := eq .TaskResult.poolDeployment.cstorpoolmgmtimage "" }}
    {{ $shouldpatch := or $isOldCStorPool $isOldCStorPoolMGMT | toString }}
    id: patchDeploymentImageStatus
    apiVersion: extensions/v1beta1
    kind: Deployment
    action: rolloutstatus
    objectName: {{ .UpgradeItem.name }}
    runNamespace: {{ .UpgradeItem.namespace }}
    retry: "20,20s"
  post: |
    {{- jsonpath .JsonResult "{.isRolledout}" | trim | saveAs "patchDeploymentImageStatus.isRolledout" .TaskResult | noop -}}
    {{- jsonpath .JsonResult "{.message}" | trim | saveAs "patchDeploymentImageStatus.rolloutStatus" .TaskResult | noop -}}
    {{- $status := "" -}}
    {{- if eq .TaskResult.patchDeploymentImageStatus.isRolledout  "true" }}
    {{- $status = .Config.successStatus.value -}}
    {{- else }}
    {{- "waiting for deployment rollout" | saveAs "patchDeploymentImageStatus.verifyErr" .TaskResult | noop -}}
    {{- $status = .Config.failStatus.value -}}
    {{- end }}

    {{- $taskName := "upgrade-cstor-pool-082-090-patch-deployment-image-status" -}}
    {{- $message := printf "%s name: {%s} namespace: {%s}" .TaskResult.patchDeploymentImageStatus.rolloutStatus .UpgradeItem.name .UpgradeItem.namespace -}}
    {{- updateUpgradeResult .UpgradeItem.upgradeResultName .UpgradeItem.upgradeResultNamespace $taskName $status $message 0 now -}}
---
apiVersion: openebs.io/v1alpha1
kind: RunTask
metadata:
  name: upgrade-cstor-pool-082-090-post-check-patch-deployment-image
  namespace: default
spec:
  meta: |
    {{ $isOldCStorPool := contains .TaskResult.poolDeployment.cstorpoolimage .Config.baseversion.value }}
    {{ $isOldCStorPoolMGMT := eq .TaskResult.poolDeployment.cstorpoolmgmtimage "" }}
    {{ $shouldpatch := or $isOldCStorPool $isOldCStorPoolMGMT | toString }}
    id: postCheckDeploymentImagePatch
    apiVersion: extensions/v1beta1
    kind: Deployment
    action: get
    objectName: {{ .UpgradeItem.name }}
    runNamespace: {{ .UpgradeItem.namespace }}
    disable: {{ ne $shouldpatch "true" }}
  post: |-
    {{- jsonpath .JsonResult "{.spec.template.spec.containers[?(@.name=='cstor-pool')].image}" | trim | saveAs "postCheckDeploymentImagePatch.cstorpoolimage" .TaskResult | noop -}}
    {{- jsonpath .JsonResult "{.spec.template.spec.containers[?(@.name=='cstor-pool-mgmt')].image}" | trim | saveAs "postCheckDeploymentImagePatch.cstorpoolmgmtimage" .TaskResult | noop -}}
    {{- jsonpath .JsonResult "{.spec.template.spec.containers[?(@.name=='maya-exporter')].image}" | trim | saveAs "postCheckDeploymentImagePatch.mayaexporterimage" .TaskResult | noop -}}

    {{ $isNewCStorPool := contains .Config.targetversion.value .TaskResult.postCheckDeploymentImagePatch.cstorpoolimage }}
    {{ $isNewCStorPoolMGMT := contains .Config.targetversion.value .TaskResult.postCheckDeploymentImagePatch.cstorpoolmgmtimage }}
    {{ $isNewMayaExporter := contains .Config.targetversion.value .TaskResult.postCheckDeploymentImagePatch.mayaexporterimage }}

    {{- $status := "" -}}
    {{- if and $isNewCStorPool $isNewCStorPoolMGMT $isNewMayaExporter }}
    {{- $status = .Config.successStatus.value -}}
    {{- else }}
    {{- $status = .Config.failStatus.value -}}
    {{- end }}
    {{- $taskName := "upgrade-cstor-pool-082-090-post-check-patch-deployment-image" -}}
    {{- $message := printf "pool image :{%s} pool mgmt image :{%s} maya-exporter image : {%s}" .TaskResult.postCheckDeploymentImagePatch.cstorpoolimage .TaskResult.postCheckDeploymentImagePatch.cstorpoolmgmtimage .TaskResult.postCheckDeploymentImagePatch.mayaexporterimage -}}
    {{- updateUpgradeResult .UpgradeItem.upgradeResultName .UpgradeItem.upgradeResultNamespace $taskName $status $message 0 now -}}
---
### Update Quorum Part
apiVersion: openebs.io/v1alpha1
kind: RunTask
metadata:
  name: upgrade-cstor-pool-082-090-list-replicaset
  namespace: default
spec:
  meta: |
    id: replicaSetList
    apiVersion: extensions/v1beta1
    kind: ReplicaSet
    action: list
    runNamespace: {{ .UpgradeItem.namespace }}
    disable: false
    options: |-
      labelSelector: app=cstor-pool,openebs.io/storage-pool-claim=cstor-sparse-pool
  post: |
    {{- $CustomJsonpath := printf "{range .items[?(@.metadata.ownerReferences[0].name== '%s')]}{@.metadata.name} {end}" .UpgradeItem.name -}}
    {{- jsonpath .JsonResult $CustomJsonpath | trim | replace " " "," | saveAs "replicaSetList.list" .TaskResult | noop -}}

    {{- $taskName := "upgrade-cstor-pool-082-090-list-replicaset" -}}
    {{- $message := printf "ReplicaSet list {%s}" .TaskResult.replicaSetList.list -}}
    {{- updateUpgradeResult .UpgradeItem.upgradeResultName .UpgradeItem.upgradeResultNamespace $taskName .Config.successStatus.value $message 0 now -}}
---
apiVersion: openebs.io/v1alpha1
kind: RunTask
metadata:
  name: upgrade-cstor-pool-082-090-list-pod
  namespace: default
spec:
  meta: |
    id: podList
    apiVersion: v1
    kind: Pod
    action: list
    runNamespace: {{ .UpgradeItem.namespace }}
    options: |-
      labelSelector: app=cstor-pool,openebs.io/storage-pool-claim=cstor-sparse-pool
    disable: false
  post: |
    {{- $CustomJsonpath := printf "{range .items[?(@.metadata.ownerReferences[0].name== '%s')]}{@.metadata.name}{end}" .TaskResult.newReplicaset.name -}}
    {{- $podrsPairs := jsonpath .JsonResult "{range .items[*]}{@.metadata.name},{@.metadata.ownerReferences[0].name} {end}" | trim | default "" | splitList " " -}}
    {{- $podrsPairs| saveAs "podList.map" .TaskResult -}}

    {{ $podName := "" }}
    {{ $replicasetName := "" }}
    {{ $replicaset := "" }}
    {{ $match := "" }}
    {{ $replicasetList := .TaskResult.replicaSetList.list | splitList "," }}

    {{- range $k, $v := .TaskResult.podList.map }}
    {{ $k := $k }}
    {{ $v := $v }}
    {{- $replicaset = $v | splitList "," | last -}}
    {{- $match := pickContains $replicaset $replicasetList -}}
    
    {{- if ne $match "" }}
    {{ $podName = $v | splitList "," | first }}
    {{ $replicasetName = $v | splitList "," | last }}
    {{- end }}

    {{ $match = "" }}

    {{- end }}
    
    {{ $staleReplicaset := .TaskResult.replicaSetList.list | replace $replicasetName ""}}
    {{ $staleReplicaset = $staleReplicaset | replace ",," "," }}
    {{ $staleReplicaset = $staleReplicaset | replace "," " " | trim }}
    {{ $staleReplicaset = $staleReplicaset | replace " " "," }}

    {{- $podName | saveAs "podList.podName" .TaskResult -}}
    {{- $replicasetName | saveAs "podList.replicasetName" .TaskResult -}}
    {{- $staleReplicaset | saveAs "podList.staleReplicaset" .TaskResult -}}

    {{- $taskName := "upgrade-cstor-pool-082-090-list-pod" -}}
    {{- $message := printf "pool Pod-ReplicaSet map: {%s}\nstale ReplicaSet list: {%s}" .TaskResult.podList.map .TaskResult.podList.staleReplicaset -}}
    {{- updateUpgradeResult .UpgradeItem.upgradeResultName .UpgradeItem.upgradeResultNamespace $taskName .Config.successStatus.value $message 0 now -}}  
---
apiVersion: openebs.io/v1alpha1
kind: RunTask
metadata:
  name: upgrade-cstor-pool-082-090-get-pool-pod
  namespace: default
spec:
  meta: |
    id: getPoolPod
    apiVersion: v1
    kind: Pod
    action: get
    objectName: {{ .TaskResult.podList.podName }}
    runNamespace: {{ .UpgradeItem.namespace }}
    disable: false
  post: |
    {{- jsonpath .JsonResult "{.spec.containers[?(@.name=='cstor-pool')].env[?(@.name=='OPENEBS_IO_CSTOR_ID')].value}" | trim | saveAs "getPoolPod.pooluid" .TaskResult | noop -}}
---
apiVersion: openebs.io/v1alpha1
kind: RunTask
metadata:
  name: upgrade-cstor-pool-082-090-pre-check-quorum
  namespace: default
spec:
  meta: |
    id: updateQuormPreCheck
    apiVersion: v1
    kind: Pod
    action: exec
    runNamespace: {{ .UpgradeItem.namespace }}
    objectName: {{ .TaskResult.podList.podName }}
    disable: false
  task: |-
    command:
    - zfs
    - get
    - quorum
    - -H
    - cstor-{{ .TaskResult.getPoolPod.pooluid }}
    - -o
    - value
    container: cstor-pool-mgmt
    stdin: false
    stdout: true
    stderr: true
  post: |-
    {{- jsonpath .JsonResult "{.Stdout}" | trim | saveAs "updateQuormPreCheck.stdout" .TaskResult | noop -}}

    {{- $taskName := "upgrade-cstor-pool-082-090-pre-check-quorum" -}}
    {{- $message := printf "value of quorum {cstor-%s} is {%s}" .TaskResult.getPoolPod.pooluid .TaskResult.updateQuormPreCheck.stdout -}}
    {{- updateUpgradeResult .UpgradeItem.upgradeResultName .UpgradeItem.upgradeResultNamespace $taskName .Config.successStatus.value $message 0 now -}}
---
apiVersion: openebs.io/v1alpha1
kind: RunTask
metadata:
  name: upgrade-cstor-pool-082-090-set-quorum
  namespace: default
spec:
  meta: |
    id: updateQuorm
    apiVersion: v1
    kind: Pod
    action: exec
    runNamespace: {{ .UpgradeItem.namespace }}
    objectName: {{ .TaskResult.podList.podName }}
    disable: {{ ne .TaskResult.updateQuormPreCheck.stdout "off" }}
  task: |-
    command:
    - zfs
    - set
    - quorum=on
    - cstor-{{ .TaskResult.getPoolPod.pooluid }}
    container: cstor-pool-mgmt
    stdin: false
    stdout: true
    stderr: true
  post: |-
    
    {{- $taskName := "upgrade-cstor-pool-082-090-set-quorum" -}}
    {{- $message := printf "successfully set quorum {cstor-%s}" .TaskResult.getPoolPod.pooluid -}}
    {{- updateUpgradeResult .UpgradeItem.upgradeResultName .UpgradeItem.upgradeResultNamespace $taskName .Config.successStatus.value $message 0 now -}}
---
apiVersion: openebs.io/v1alpha1
kind: RunTask
metadata:
  name: upgrade-cstor-pool-082-090-post-check-quorum
  namespace: default
spec:
  meta: |
    id: updateQuormPostCheck
    apiVersion: v1
    kind: Pod
    action: exec
    runNamespace: {{ .UpgradeItem.namespace }}
    objectName: {{ .TaskResult.podList.podName }}
    disable: {{ ne .TaskResult.updateQuormPreCheck.stdout "off" }}
  task: |-
    command:
    - zfs
    - get
    - quorum
    - -H
    - cstor-{{ .TaskResult.getPoolPod.pooluid }}
    - -o
    - value
    container: cstor-pool-mgmt
    stdin: false
    stdout: true
    stderr: true
  post: |-
    {{- jsonpath .JsonResult "{.Stdout}" | trim | saveAs "updateQuormPostCheck.stdout" .TaskResult | noop -}}

    {{- $taskName := "upgrade-cstor-pool-082-090-post-check-quorum" -}}
    {{- $message := printf "value of quorum {cstor-%s} is {%s}" .TaskResult.getPoolPod.pooluid .TaskResult.updateQuormPostCheck.stdout -}}
    {{- updateUpgradeResult .UpgradeItem.upgradeResultName .UpgradeItem.upgradeResultNamespace $taskName .Config.successStatus.value $message 0 now -}}
---
apiVersion: openebs.io/v1alpha1
kind: RunTask
metadata:
  name: upgrade-cstor-pool-082-090-pool-deployment-status
  namespace: default
spec:
  meta: |
    id: poolDeploymentImageStatus
    apiVersion: extensions/v1beta1
    kind: Deployment
    action: rolloutstatus
    objectName: {{ .UpgradeItem.name }}
    runNamespace: {{ .UpgradeItem.namespace }}
    disable: false
  post: |
    {{- jsonpath .JsonResult "{.isRolledout}" | trim | saveAs "poolDeploymentStatus.isRolledOut" .TaskResult | noop -}}
    {{- jsonpath .JsonResult "{.message}" | trim | saveAs "poolDeploymentStatus.rolloutStatus" .TaskResult | noop -}}
    {{- if eq .TaskResult.poolDeploymentStatus.isRolledOut  "true" }}
    {{- else }}
    {{- "waiting for deployment rollout" | saveAs "poolDeploymentStatus.verifyErr" .TaskResult | noop -}}
    {{- end }}
---
apiVersion: openebs.io/v1alpha1
kind: RunTask
metadata:
  name: upgrade-cstor-pool-082-090-patch-sp-version
  namespace: default
spec:
  meta: |
    id: patchStoragePool
    apiVersion: openebs.io/v1alpha1
    kind: StoragePool
    action: patch
    objectName: {{ .UpgradeItem.name }}
  task: |-
    type: merge
    pspec: |-
      metadata:
        labels:
          openebs.io/version: {{ .Config.targetversion.value }}
          openebs.io/previus-version: {{ .Config.baseversion.value }}
  post: |-
    {{- $taskName := "upgrade-cstor-pool-082-090-patch-sp-version" -}}
    {{- $message := printf "version label successfully patched StoragePool {%s}." .UpgradeItem.name -}}
    {{- updateUpgradeResult .UpgradeItem.upgradeResultName .UpgradeItem.upgradeResultNamespace $taskName .Config.successStatus.value $message 0 now -}}
  
---
apiVersion: openebs.io/v1alpha1
kind: RunTask
metadata:
  name: upgrade-cstor-pool-082-090-patch-sp-version-post-check
  namespace: default
spec:
  meta: |
    id: postCheckStoragePoolVersionPatch
    apiVersion: openebs.io/v1alpha1
    kind: StoragePool
    action: get
    objectName: {{ .UpgradeItem.name }}
    disable: false
  post: |
    {{- jsonpath .JsonResult "{.metadata.labels.openebs\\.io/version}" | trim | saveAs "postCheckStoragePoolVersionPatch.version" .TaskResult | noop -}}

    {{- $taskName := "upgrade-cstor-pool-082-090-patch-sp-version-post-check" -}}
    {{- $status := "" -}}
    {{- if ne .TaskResult.postCheckStoragePoolVersionPatch.version .Config.targetversion.value }}
    {{- $status = .Config.failStatus.value -}}
    {{- else }}
    {{- $status = .Config.successStatus.value -}}
    {{- end }}
    {{- $message := printf "version label value - {%s}" .TaskResult.postCheckStoragePoolVersionPatch.version -}}
    {{- updateUpgradeResult .UpgradeItem.upgradeResultName .UpgradeItem.upgradeResultNamespace $taskName .Config.successStatus.value $message 0 now -}}
---
apiVersion: openebs.io/v1alpha1
kind: RunTask
metadata:
  name: upgrade-cstor-pool-082-090-patch-csp-version
  namespace: default
spec:
  meta: |
    id: patchCStorPool
    apiVersion: openebs.io/v1alpha1
    kind: CStorPool
    action: patch
    objectName: {{ .UpgradeItem.name }}
  task: |-
    type: merge
    pspec: |-
      metadata:
        labels:
          openebs.io/version: {{ .Config.targetversion.value }}
          openebs.io/previus-version: {{ .Config.baseversion.value }}
  post: |-
    {{- $taskName := "upgrade-cstor-pool-082-090-patch-csp-version" -}}
    {{- $message := printf "version label successfully patched CStorPool {%s}." .UpgradeItem.name -}}
    {{- updateUpgradeResult .UpgradeItem.upgradeResultName .UpgradeItem.upgradeResultNamespace $taskName .Config.successStatus.value $message 0 now -}}

---
apiVersion: openebs.io/v1alpha1
kind: RunTask
metadata:
  name: upgrade-cstor-pool-082-090-patch-csp-version-post-check
  namespace: default
spec:
  meta: |
    id: postCheckCStorPoolVersionPatch
    apiVersion: openebs.io/v1alpha1
    kind: CStorPool
    action: get
    objectName: {{ .UpgradeItem.name }}
    disable: false
  post: |
    {{- jsonpath .JsonResult "{.metadata.labels.openebs\\.io/version}" | trim | saveAs "postCheckCStorPoolVersionPatch.version" .TaskResult | noop -}}

    {{- $taskName := "upgrade-cstor-pool-082-090-patch-csp-version-post-check" -}}
    {{- $status := "" -}}
    {{- if ne .TaskResult.postCheckCStorPoolVersionPatch.version .Config.targetversion.value }}
    {{- $status = .Config.failStatus.value -}}
    {{- else }}
    {{- $status = .Config.successStatus.value -}}
    {{- end }}
    {{- $message := printf "version label value - {%s}" .TaskResult.postCheckCStorPoolVersionPatch.version -}}
    {{- updateUpgradeResult .UpgradeItem.upgradeResultName .UpgradeItem.upgradeResultNamespace $taskName .Config.successStatus.value $message 0 now -}}
---
apiVersion: openebs.io/v1alpha1
kind: RunTask
metadata:
  name: upgrade-cstor-pool-082-090-patch-deployment-version
  namespace: default
spec:
  meta: |
    id: patchDeployment
    apiVersion: extensions/v1beta1
    kind: Deployment
    action: patch
    objectName: {{ .UpgradeItem.name }}
    runNamespace: {{ .UpgradeItem.namespace }}
  task: |-
    type: strategic
    pspec: |-
      metadata:
        labels:
          openebs.io/version: {{ .Config.targetversion.value }}
          openebs.io/previus-version: {{ .Config.baseversion.value }}
  post: |-
    {{- $taskName := "upgrade-cstor-pool-082-090-patch-deployment-version" -}}
    {{- $message := printf "version label successfully patched Pool Deployment {%s} in {%s} namespace." .UpgradeItem.name .UpgradeItem.namespace -}}
    {{- updateUpgradeResult .UpgradeItem.upgradeResultName .UpgradeItem.upgradeResultNamespace $taskName .Config.successStatus.value $message 0 now -}}

---
apiVersion: openebs.io/v1alpha1
kind: RunTask
metadata:
  name: upgrade-cstor-pool-082-090-patch-deployment-version-post-check
  namespace: default
spec:
  meta: |
    id: postCheckDeploymentVersionPatch
    apiVersion: extensions/v1beta1
    kind: Deployment
    action: get
    objectName: {{ .UpgradeItem.name }}
    runNamespace: {{ .UpgradeItem.namespace }}
    disable: false
  task: |
    {{- jsonpath .JsonResult "{.metadata.labels.openebs\\.io/version}" | trim | saveAs "postCheckDeploymentVersionPatch.version" .TaskResult | noop -}}

    {{- $taskName := "upgrade-cstor-pool-082-090-patch-deployment-version-post-check" -}}
    {{- $status := "" -}}
    {{- if ne .TaskResult.postCheckDeploymentVersionPatch.version .Config.targetversion.value }}
    {{- $status = .Config.failStatus.value -}}
    {{- else }}
    {{- $status = .Config.successStatus.value -}}
    {{- end }}
    {{- $message := printf "version label value - {%s}" .TaskResult.postCheckDeploymentVersionPatch.version -}}
    {{- updateUpgradeResult .UpgradeItem.upgradeResultName .UpgradeItem.upgradeResultNamespace $taskName .Config.successStatus.value $message 0 now -}}
---
apiVersion: openebs.io/v1alpha1
kind: RunTask
metadata:
  name: upgrade-cstor-pool-082-090-delete-replicaset
  namespace: default
spec:
  meta: |
    id: deleteOldReplicaset
    apiVersion: extensions/v1beta1
    kind: ReplicaSet
    action: delete
    runNamespace: {{ .UpgradeItem.namespace }}
    objectName: {{ .TaskResult.podList.staleReplicaset }}
    disable: {{ eq .TaskResult.podList.staleReplicaset "" }}
  post: |
    {{- $taskName := "upgrade-cstor-pool-082-090-delete-replicaset" -}}
    {{- $message := printf "stale replicaset {%s} successfully deleted in {%s} namespace." .TaskResult.podList.staleReplicaset .UpgradeItem.namespace -}}
    {{- updateUpgradeResult .UpgradeItem.upgradeResultName .UpgradeItem.upgradeResultNamespace $taskName .Config.successStatus.value $message 0 now -}}